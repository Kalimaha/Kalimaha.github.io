<html>
    <head>
      <title>Create a serverless full-stack web-app with a single file</title>

      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
      <meta name="format-detection" content="telephone=no">
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
      <meta name="description" content="Can we create a fully working full-stack web-app based on RESTful services with a single file?">
      <meta name="robots" content="index,follow">

      <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
        ga('create', 'UA-87710589-1', 'auto');
        ga('send', 'pageview');
      </script>
      <script type="application/ld+json">
        {
          "@context":"http://schema.org",
          "@type":"BlogPosting",
          "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "http://guido-barbaglia.blog/posts/create_a_serverless_full-stack_web-app_with_a_single_file.html"
          },
          "headline":"Create a serverless full-stack web-app with a single file",
          "description":"Can we create a fully working full-stack web-app based on RESTful services with a single file?",
          "author": {
              "@type": "Person",
              "name": "Guido Barbaglia"
          },
          "datePublished": "2017-01-05T11:41:33.190Z",
          "dateModified": "2017-01-05T11:41:33.190Z",
          "publisher": {
            "@type": "Organization",
            "name": "Guido Barbaglia",
            "logo": {
              "@type": "ImageObject",
              "url": "http://guido-barbaglia.blog/src/images/portrait.jpg",
              "width": "150",
              "height": 60
            }
          },
          "image": {
            "@type": "ImageObject",
            "url": "http://guido-barbaglia.blog/src/images/create_a_serverless_full-stack_web-app_with_a_single_file.png",
            "height": 150,
            "width": "150"
          }
        }
      </script>

      <meta name="twitter:card" content="summary" />
      <meta name="twitter:site" content="http://guido-barbaglia.blog/posts/create_a_serverless_full-stack_web-app_with_a_single_file.html" />
      <meta name="twitter:title" content="Create a serverless full-stack web-app with a single file" />
      <meta name="twitter:description" content="Can we create a fully working full-stack web-app based on RESTful services with a single file?" />
      <meta name="twitter:image" content="http://guido-barbaglia.blog/src/images/create_a_serverless_full-stack_web-app_with_a_single_file.png" />
      
      <meta property="og:url" content="http://guido-barbaglia.blog/posts/create_a_serverless_full-stack_web-app_with_a_single_file.html" />
      <meta property="og:type" content="article" />
      <meta property="og:title" content="Create a serverless full-stack web-app with a single file" />
      <meta property="og:description" content="Can we create a fully working full-stack web-app based on RESTful services with a single file?" />
      <meta property="og:image" content="http://guido-barbaglia.blog/src/images/create_a_serverless_full-stack_web-app_with_a_single_file.png" />

      <link rel="shortcut icon" href="../src/icons/favicon.ico">
      <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet">
      <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
      <link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">
      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.8.0/styles/default.min.css">
        <link href="../src/css/guido-barbaglia.css" rel="stylesheet">

      <script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
      <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.8.0/highlight.min.js"></script>
      <script src="https://cdn.rawgit.com/showdownjs/showdown/1.5.1/dist/showdown.min.js"></script>

      <script>
        function enhance() {
            const pres = $('pre');
            for (var idx of Array(pres.length).keys()) { hljs.highlightBlock(pres.get(idx)) }
            $('table').addClass('table table-striped table-bordered table-condensed table-hover');
            $('a').addClass('keyword');
        }
      </script>
    </head>

    <body onload="enhance();">
      <br class="hidden-xs hidden-sm">
      <br class="hidden-xs hidden-sm">
      <div class="container">
        <hr>
        <h4 class="text-center">
          <a href="../">Home</a>
        </h4>
        <hr>
        <br>

        <div class='row'>
          <div class='col-lg-4 hidden-xs hidden-sm hidden-md hidden-print'>
            <img  src='../src/images/create_a_serverless_full-stack_web-app_with_a_single_file.png'
                  class='img-responsive img-circle center-block'
                  style="border: 1px solid #000;" >
            <br>
          </div>
          <div class='col-lg-8'>
            <div class='row'>
              <div class='col-lg-11'>
                <div class='summary'>
                  <p>Can we create a fully working full-stack web-app based on RESTful services with a single file?</p>
                </div>
              </div>
            </div>
          </div>
        </div>
        <hr>
        <div class='row'>
          <div class='col-lg-12'>
            <article>
                <h1 id="createafullstackserverlesswebappwithasinglefile">Create a full-stack serverless web-app with a single file</h1>
<p><hr>
<br></p>
<p><a href="https://en.wikipedia.org/wiki/Serverless_computing">Serverless</a> is one of the
biggest buzzwords of these years, and the implementation of solutions based on
such architecture has been boosted by the release of
<a href="https://aws.amazon.com/lambda/">AWS Lambda</a>. This post describes a
little experiment I conducted to learn more about this technology. I wanted to
define and deploy a fully functional web-app (<em>both back-end and front-end</em>)
based on RESTful services with <strong>one single file</strong>.</p>
<p>The web-app itself is a very simple guestbook, that allows users to post short
messages and read what other users previously posted. The app consists of a
simple HTML client with some JQuery in it, and two Python RESTful services used
to retrieve and create messages. This simple architecture is shown in the
picture below.</p>
<p><img class="img-responsive center-block" src="../src/images/serverless_guestbook_01.png"></p>
<p>Through the use of <a href="https://aws.amazon.com/it/cloudformation/">AWS CloudFormation</a>
it is possible to configure, create, deploy and orchestrate all these resources
with a single file. The source code of the Serverless Guestbook experiment
is available on GitHub at <a href="https://github.com/Kalimaha/serverless-guestbook">this link</a>.</p>
<h2 id="whatisserverlessanyway">What is serverless anyway?</h2>
<p>According to <a href="http://martinfowler.com/articles/serverless.html">Martin Fowler</a>:</p>
<blockquote>
  <p>Serverless can [...] mean applications where some amount of server-side logic
  is still written by the application developer but unlike traditional
  architectures is run in stateless compute containers that are event-triggered,
  ephemeral (<em>may only last for one invocation</em>), and fully managed by a 3rd
  party.</p>
</blockquote>
<p>In the Serverless Guestbook experiment, the entire source code of the
server-side logic is defined in the configuration file. I don't know anything
about the deployment and management of my Lambda functions, which are stateless
and event triggered. What is more, I don't know any details of the management
and deployment of any of the components of my architecture: the DB, the gateway,
and so forth.</p>
<p>Let's start!</p>
<h2 id="datastorage">Data Storage</h2>
<p>The first piece of the system is the data storage. I only need one table to
store the guestbook messages. I will then define a new
<a href="https://aws.amazon.com/dynamodb/">DynamoDB</a> resource in my CloudFormation
file as follows:</p>
<pre><code>DB:
  Type: "AWS::DynamoDB::Table"
  Properties:
    TableName: Messages
    AttributeDefinitions:
      - AttributeName: MessageID
        AttributeType: S
    KeySchema:
      - AttributeName: MessageID
        KeyType: HASH
    ProvisionedThroughput:
      ReadCapacityUnits: 5
      WriteCapacityUnits: 5
</code></pre>
<p><br></p>
<p>DynamoDB is schema-less, I only need to define the name of the table
(<em>Messages</em>), and a single attribute that will be used as the primary key
(<em>MessageID</em>). We will store more information in the DB, but AWS doesn't need
to know about it.</p>
<h2 id="frontend">Front-end</h2>
<h3 id="s3websitehosting">S3 web-site hosting</h3>
<p>The front-end has only one element, a simple HTML page with some JavaScript code
embedded into it. <a href="https://aws.amazon.com/s3/">S3</a> is a simple storage service
that can be easilly configured to serve static content. The bucket can be
created as follows:</p>
<pre><code>S3Bucket:
  Type: "AWS::S3::Bucket"
  Properties:
    BucketName: serverless-guestbook
    AccessControl: PublicRead
    WebsiteConfiguration:
      IndexDocument: index.html
</code></pre>
<p><br></p>
<p>I will use a policy to configure the S3 to serve our static page:</p>
<pre><code>S3BucketPolicy:
  Type: "AWS::S3::BucketPolicy"
  Properties:
    Bucket: !Ref S3Bucket
    PolicyDocument:
      Statement:
        - Sid: PublicReadForGetBucketObjects
          Effect: Allow
          Principal: "*"
          Resource:
            - "arn:aws:s3:::serverless-guestbook/*"
          Action:
            - "s3:GetObject"
</code></pre>
<p><br></p>
<h3 id="htmlandjavascript">HTML and JavaScript</h3>
<p>The HTML page defines a simple form and a list of messages retrieved from the
DB. The source code is available
<a href="https://gist.github.com/Kalimaha/1c11308f7bd3bb66ecb48d54a0674952">here</a> and
the UI is shown below.</p>
<p><img class="img-responsive center-block" src="../src/images/serverless_guestbook_02.png"></p>
<h3 id="populatethebucket">Populate the Bucket</h3>
<p>I defined an S3 bucket capable to serve static content. I also have an HTML
client for my services. How do I link the two, in the same file? I can I
populate the bucket after its creation with the HTML client? The easiest thing
is to use the <code>putObject</code> method of the <a href="https://aws.amazon.com/it/sdk-for-node-js/">AWS NodeJS SDK</a>.
Such method takes a string (<em>the whole source code of the front-end in this case</em>)
and creates a file in the given bucket. At this point I need something to
execute this source code, therefore I need to define a Lambda function, as
describe at
<a href="https://github.com/Kalimaha/serverless-guestbook/blob/master/stack.yml#L31">line 31</a>
of the CloudFormation file.</p>
<h3 id="triggerthelambda">Trigger the Lambda</h3>
<p>I have a Lambda function capable to put the HTML code in the S3 bucket. But this
is just the <strong>description</strong> of a function, I need something to <strong>trigger</strong> such
function. To achieve such goal, it is possible to define a
<a href="http://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/template-custom-resources.html">CustomResource</a>,
which:</p>
<blockquote>
  <p>enable you to write custom provisioning logic in templates that AWS
  CloudFormation runs anytime you create, update (<em>if you changed the custom
  resource</em>), or delete stacks</p>
</blockquote>
<p>Basically, after the CloudFormation stack has been created, AWS triggers the
custom resource, which is linked to the Lambda. Its definition is very simple:</p>
<pre><code>CustomResourcePopulateS3:
  Type: "Custom::PopulateS3"
  Version: 1.0
  Properties:
    ServiceToken: !GetAtt [ LambdaPopulateS3, Arn ]
</code></pre>
<p><br></p>
<p>Please note that the custom resource needs to receive a response from the Lambda
function that has been triggered. AWS provides a JavaScript library for the
NodeJS SDK. Such library must be imported in the Lambda function:</p>
<pre><code>var response = require('cfn-response');
</code></pre>
<p><br></p>
<p>And then it is invoked at the end of the Lambda function to send a response
to the custom resource:</p>
<pre><code>s3.putObject(params, function(err, data) {
  if (err) response.send(event, context, response.FAILURE, data)
  else     response.send(event, context, response.SUCCESS, data)
})
</code></pre>
<p><br></p>
<p>The CustomResource mechanism is summarized in the image below:</p>
<p><img class="img-responsive center-block" src="../src/images/serverless_guestbook_03.png"></p>
<h2 id="backend">Back-end</h2>
<h3 id="createandretrievedata">Create and Retrieve Data</h3>
<p>The business logic of the whole application is composed by two RESTful services:
a GET request to fetch all the messages from th DB, and a POST call to create
a new message. I can define a Lambda function for each service, and each function
will use the AWS SDK to query the DynamoDB table. I have previously used the
NodeJS SDK to populate the S3 bucket to take advantage of the <em>cfn-response</em>
library, but I will favour the Python SDK to communicate with the DB. The GET
function retrieves and sort all the messages in the table:</p>
<pre><code>LambdaGet:
  Type: "AWS::Lambda::Function"
  Properties:
    FunctionName: GetMessages
    Handler: index.handler
    Role: !GetAtt [ LambdaFunctionRole, Arn ]
    Runtime: python2.7
    Code:
      ZipFile: &gt;
        import boto3
        def handler(event, context):
          messages = []
          db_client = boto3.client('dynamodb')
          items = db_client.scan(TableName='Messages', Select='ALL_ATTRIBUTES')['Items']
          for item in items:
            messages.append({
              'message':  item['Message']['S'],
              'author':   item['Author']['S'],
              'date':     item['Date']['S']
            })
          return sorted(messages, key=lambda msg: msg['date'], reverse=True)
</code></pre>
<p><br></p>
<p>On the other hand, the POST function reads the message and the author from the
front-end, generates the ID and the date, and stores the new message in the
DB:</p>
<pre><code>LambdaPost:
  Type: "AWS::Lambda::Function"
  Properties:
    FunctionName: PostMessage
    Handler: index.handler
    Role: !GetAtt [ LambdaFunctionRole, Arn ]
    Runtime: python2.7
    Code:
      ZipFile: &gt;
        import boto3, datetime, uuid
        def handler(event, context):
          db_client = boto3.client('dynamodb')
          response = db_client.put_item(
            TableName = 'Messages',
            Item = {
              'MessageID':  { 'S': uuid.uuid1().urn },
              'Message':    { 'S': event['message'] },
              'Author':     { 'S': event['author'] },
              'Date':       { 'S': datetime.datetime.utcnow().isoformat() }
            }
          )
          return response
</code></pre>
<p><br></p>
<h3 id="api">API</h3>
<p>The Lambda functions are ready to be executed, by I need to expose them as API
to be able to use them from the front-end. This part is a bit verbose, because
I need to define several resources. I need an
<a href="https://github.com/Kalimaha/serverless-guestbook/blob/master/stack.yml#L315">API Account</a>
to be able to use <a href="https://github.com/Kalimaha/serverless-guestbook/blob/master/stack.yml#L320">CloudWatch logs</a>.
Then I need to define an <a href="https://github.com/Kalimaha/serverless-guestbook/blob/master/stack.yml#L206">API Gateway</a>,
a <a href="https://github.com/Kalimaha/serverless-guestbook/blob/master/stack.yml#L211">gateway role</a>
to grant permissions to my API, and finally a
<a href="https://github.com/Kalimaha/serverless-guestbook/blob/master/stack.yml#L301">deploy</a>
and a <a href="https://github.com/Kalimaha/serverless-guestbook/blob/master/stack.yml#L308">stage</a>.
For each Lambda function I also need to define a method. For example, the
GET method is defined as follows:</p>
<pre><code>GetMessagesREST:
  Type: "AWS::ApiGateway::Method"
  Properties:
    AuthorizationType: NONE
    HttpMethod: GET
    Integration:
      Credentials: !GetAtt [ APIGatewayRole, Arn ]
      IntegrationHttpMethod: POST
      IntegrationResponses:
        - StatusCode: 200
          ResponseParameters:
            method.response.header.Access-Control-Allow-Headers: "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token'"
            method.response.header.Access-Control-Allow-Methods: "'GET,OPTIONS'"
            method.response.header.Access-Control-Allow-Origin: "'*'"
      Type: AWS
      PassthroughBehavior: WHEN_NO_MATCH
      Uri:
        !Join
          - ""
          -
            - "arn:aws:apigateway:ap-southeast-2:lambda:path/2015-03-31/functions/"
            - !GetAtt [ LambdaGet, Arn ]
            - "/invocations"
    MethodResponses:
    - StatusCode: 200
      ResponseParameters:
        method.response.header.Access-Control-Allow-Headers: false
        method.response.header.Access-Control-Allow-Methods: false
        method.response.header.Access-Control-Allow-Origin: false
    ResourceId: !GetAtt [ APIGateway, "RootResourceId" ]
    RestApiId: !Ref APIGateway
</code></pre>
<p><br></p>
<p>This type of resource defines the HTTP method, the inputs, the outputs, the
integration with the Lambda function and the headers of each REST service. Such
headers are very important to define CORS filters and be able to consume such
services from the front-end. To summarize, we need the following resources:</p>
<ul>
<li><a href="http://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-apigateway-account.html">API Gateway Account</a></li>
<li><a href="http://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-apigateway-restapi.html">API Gateway  REST API</a></li>
<li><a href="http://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-apigateway-deployment.html">API Gateway Deployment</a></li>
<li><a href="http://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-apigateway-stage.html">API Gateway Stage</a></li>
<li><a href="http://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-apigateway-method.html">API Gateway Method</a>
(<em>one for each endpoint</em>)</li>
</ul>
<h2 id="conclusions">Conclusions</h2>
<p>Well, I made it! I was able to define, deploy and orchestrate an entire fully
functional web-app based on RESTful service with a single file!</p>
<p>First of all I have created a schemaless DB with a single table. Then I defined
an S3 bucket to host my static content, and a Lambda function (<em>triggered
by a custom resource</em>) to populate such bucket when the stack is created.
Defining the whole front-end client <strong>inline</strong> inside a Lambda function was a
bit of a stretch of course, but I wanted to put everything in ONE file! After
that I had to configure the whole environment for my API: an account, a
deployment, a stage and an endpoint for each service. Finally, I implemented
two different Lambda functions capable to query the DB.</p>
<p>The whole experiment was quite interesting, and the final result is not too bad.
I expected the Lambda functions to be slow (<em>especially after long periods
of non-usage of the service</em>), but I have experienced a better response time
compared to Heroku's Dynos. The development process is quite long and painful,
because the only way to test the stack is to deploy it and try the various
components, especially their interactions. The CustomResource is particularly
fragile, and any error in the usage of the <em>cfn-response</em> library will lead to
a huge waste of time.</p>
<p>On the other hand, this could be an interesting way to prototype simple apps and
experiment with different technologies and setups. For example, I have used two
different SDK's (<em>NodeJS and Python</em>) for two different use cases in the same
project. What is more, you don't have to worry about any <em>ops</em> settings, because
AWS will manage almost everyting for you!</p>
            </article>
          </div>
        </div>
        <br>
        <hr>
        <div class="row">
          <div class="col-lg-12 text-center">
              <a id="twitter" class="keyword" target="_blank" title="Share it on Twitter" href="https://twitter.com/intent/tweet?text=Create a serverless full-stack web-app with a single file&url=http://guido-barbaglia.blog/posts/create_a_serverless_full-stack_web-app_with_a_single_file.html">
                  <i class="fa fa-twitter fa-2x"></i></a>
              &nbsp;
              <a id="linkedin" class="keyword" target="_blank" title="Share it on LinkedIn" href="http://www.linkedin.com/shareArticle?mini=true&url=http://guido-barbaglia.blog/posts/create_a_serverless_full-stack_web-app_with_a_single_file.html&title=Create a serverless full-stack web-app with a single file">
                  <i class="fa fa-linkedin fa-2x"></i></a>
              &nbsp;
              <a id="reddit" class="keyword" target="_blank" title="Share it on Reddit" href="http://www.reddit.com/submit?url=http://guido-barbaglia.blog/posts/create_a_serverless_full-stack_web-app_with_a_single_file.html&title=Create a serverless full-stack web-app with a single file">
                  <i class="fa fa-reddit fa-2x"></i></a>
              &nbsp;
              <a id="facebook" class="keyword" target="_blank" title="Share it on Facebook" href="http://www.facebook.com/sharer/sharer.php?u=http://guido-barbaglia.blog/posts/create_a_serverless_full-stack_web-app_with_a_single_file.html&title=Create a serverless full-stack web-app with a single file">
                  <i class="fa fa-facebook fa-2x"></i></a>
              &nbsp;
              <a id="google-plus" class="keyword" target="_blank" title="Share it on Google+" href="https://plus.google.com/share?url=http://guido-barbaglia.blog/posts/create_a_serverless_full-stack_web-app_with_a_single_file.html">
                  <i class="fa fa-google-plus fa-2x"></i></a>
          </div>
        </div>
        <hr>
        <div class="row">
          <div class="col-lg-12">
            <div id="disqus_thread"></div>
            <script>
                (function() {
                    var d = document, s = d.createElement('script');
                    s.src = '//guido-barbaglia.disqus.com/embed.js';
                    s.setAttribute('data-timestamp', +new Date());
                    (d.head || d.body).appendChild(s);
                })();
            </script>
          </div>
        </div>
        <hr>
        <script src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&adInstanceId=03df545c-279d-4a52-a4e4-f6e790dd0f1c&storeId=guidobarbagli-20"></script>
        <hr>
        <p class="text-center">
          &copy; 2016 Guido Barbaglia
        </p>
        <hr>
      </div>
      <div id="imports"></div>
      <br class="hidden-xs hidden-sm">
      <br class="hidden-xs hidden-sm">
    </body>
</html>
